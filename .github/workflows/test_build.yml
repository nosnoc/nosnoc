name: NOSNOC Test suite

on:
  pull_request:
    branches:
      - main
  # FIXME: again temporary.
  workflow_dispatch:
  push:

jobs:
  # Main job that runs all the tests for NOSNOC in matlab.
  test_nosnoc:
    runs-on: ubuntu-20.04

    steps:
    - uses: actions/checkout@v3

    - name: Install MATLAB
      uses: matlab-actions/setup-matlab@v1
      with:
        # TODO: what version do we want to use, this is the earliest one available.
        release: R2020a
        
    # TODO: Definitely cache this.
    - name: Download CasADi release
      uses: robinraju/release-downloader@v1.6
      with:
        repository: "casadi/casadi"
        tag: "3.5.5"
        fileName: "casadi-linux-matlabR2014b-v3.5.5.tar.gz"

    # untar the casadi 3.5.5 release and then add it to the matlab path.
    - name: Install CasADi
      shell: bash
      run: |
        tar -zxvf $GITHUB_WORKSPACE/casadi-linux-matlabR2014b-v3.5.5.tar.gz . -C casadi
        echo "MATLABPATH=$MATLABPATH:$(pwd)/casadi" >> $GITHUB_ENV

    - name: Install NOSNOC
      shell: bash
      run: |
        echo "MATLABPATH=$MATLABPATH:$(pwd)/casadi" >> $GITHUB_ENV
    # FIXME: This is just for debugging purposes.
    - name: Check casadi install.
      continue-on-error: true
      uses: matlab-actions/run-command@v1.1.2
      with:
        command: cd test; check_casadi

    - name: Debugging is fun
      shell: bash
      run: |
        echo "------------------ws-----------------"
        ls $GITHUB_WORKSPACE
        echo "----------------casadi---------------"
        ls casadi
